<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced 3D Excel Database & Chart Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary: #57b3fd;
      --secondary: #111e29;
      --accent: #7947e6;
      --border: #e3e9f5;
      --bg-glass: rgba(255,255,255,0.65);
      --glass-blur: 8px;
      --radius: 18px;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #eaf0fb 0%, #f9fafe 100%);
      min-height: 100%;
      user-select: none;
    }
    .container {
      box-sizing: border-box;
      max-width: 1200px;
      margin: 24px auto;
      padding: 32px 20px 24px 20px;
      background: var(--bg-glass);
      border-radius: var(--radius);
      box-shadow: 0 12px 36px rgba(80,140,220,0.22), 0 2px 8px #eceffc;
      backdrop-filter: blur(var(--glass-blur));
      position: relative;
      transition: box-shadow 0.4s cubic-bezier(.43,.01,.35,1.03);
      animation: appearIn 0.8s cubic-bezier(.43,.01,.35,1.03);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    @media (max-width: 700px) {
      .container {
        max-width: 98vw;
        padding: 12px 2vw 18px 2vw;
      }
      .input-row {
        flex-direction: column !important;
        gap: 4px;
      }
    }
    @keyframes appearIn {
      from { opacity: 0; transform: translateY(32px) scale(0.98);}
      to   { opacity: 1; transform: none;}
    }
    h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 2rem;
      font-weight: 600;
      color: var(--secondary);
      letter-spacing: -0.02em;
      text-shadow: 0 2px 36px #aecefb38;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    h2 button {
      font-size: 1.1rem;
      padding: 7px 15px;
      border-radius: 8px;
      border: none;
      background: var(--danger);
      color: white;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    h2 button:hover {
      background: #c02222;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    .tab-button {
      font-family: inherit;
      font-size: 1em;
      border: none;
      background: linear-gradient(132deg, #fff 60%, #f2f8ffe9 100%);
      color: #347bd6;
      border-radius: 10px 10px 0 0;
      padding: 7px 20px 7px 18px;
      box-shadow: 0 0.5px 5px #bfdcff24, 0 0.5px 2.5px #fff0;
      margin-bottom: -8px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
      letter-spacing: -0.01em;
      position: relative;
      top: 8px;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-button.active {
      background: linear-gradient(120deg, #3fa6fbcc, #d3edfcce 60%);
      color: var(--secondary);
      box-shadow: 0 2px 20px #badfff2a, 0 3px 12px #7eb0ea18;
      z-index: 8;
      top: 0;
    }
    .tab-button:not(.active):hover {
      background: #f4f7fc;
      color: var(--primary);
    }
    .tab-button button {
      background-color: #ef4444;
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      padding: 2px 8px;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    .tab-button button:hover {
      background-color: #c30000;
    }
    input[type="file"] {
      padding: 4px;
      background: none;
      border: none;
      font-family: inherit;
      user-select: none;
    }
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 11px;
      flex-wrap: wrap;
      user-select: none;
    }
    .input-row input,
    .input-row select {
      border: 1.7px solid var(--border);
      background: #f6f8ffcc;
      border-radius: 9px;
      font-size: 1em;
      outline: none;
      flex: 1;
      min-width: 120px;
      padding: 7px 11px;
      transition: box-shadow 0.21s, border 0.18s, background 0.33s;
      box-shadow: 0 0.5px 2px #b8c9ec13;
      margin: 2px 0;
      user-select: text;
    }
    .input-row input:focus,
    .input-row select:focus {
      border-color: var(--primary);
      box-shadow: 0 1px 8px #6dc5fa38;
    }
    .input-row select {
      background: #f2f7fb;
    }
    button {
      transition:
        background 0.18s cubic-bezier(0.49, 0.14, 0.26, 1.03),
        color 0.12s,
        transform 0.23s cubic-bezier(0.6, 0.18, 0.34, 0.98);
      background: linear-gradient(135deg, var(--primary) 85%, var(--accent) 100%);
      color: #fff;
      font-weight: 600;
      border-radius: 7px;
      text-shadow: 0 1px 2px #8ccdff38;
      border: none;
      margin-right: 3px;
      font-size: 1.08em;
      box-shadow: 0 1.5px 18px #c0dcf52c;
      letter-spacing: -0.01em;
      padding: 9.5px 18px;
      cursor: pointer;
      outline: none;
      margin-bottom: 9px;
      margin-top: 4px;
      will-change: transform;
      user-select: none;
    }
    button:active {
      background: linear-gradient(135deg, #47a6fa 80%, #583eed 100%);
      color: #fff;
      transform: scale(0.94);
      box-shadow: 0 0.8px 8px #dbefff44;
    }
    button:hover {
      background: linear-gradient(134deg, #50c0fc 70%, #694bfd 112%);
      color: #ecf4fa;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 2.5px 24px #d7f7ff4b;
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success), #16a34a);
    }
    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #d97706);
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
    }
    table {
      background: #fffffae8;
      border-radius: 9px;
      box-shadow: 0 2px 28px #b0c6e619, 0 1.3px 9px #e3e6fc19;
      overflow-x: auto;
      width: 100%;
      border-collapse: collapse;
      user-select: none;
    }
    th,
    td {
      font-size: 1em;
      padding: 10px;
      text-align: left;
      border: 1px solid #ccc;
      user-select: text;
    }
    th {
      background: linear-gradient(120deg, #57b3fd, #c3e0ff 70%);
      color: #222;
      border-radius: 4px 4px 0 0;
      border: none;
      font-weight: 600;
      transition: background 0.17s;
      position: relative;
      user-select: none;
    }
    th[contenteditable="true"]:focus {
      background: #7947e6 !important;
      color: white;
    }
    td[contenteditable="true"]:focus {
      background: #e9f4fb;
      outline: 1.2px solid #bab3fc;
    }
    td {
      border-radius: 7px;
      transition: background 0.18s;
      background-color: #f9f9f9;
    }
    td:not([contenteditable="true"]):hover {
      background: #eaf7fa95;
    }
    th .handle {
      font-size: 1.1em;
      color: #648dc7;
      cursor: move;
      margin-right: 6px;
      user-select: none;
    }
    /* New Delete Column Button on header */
    th .del-col-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9em;
      padding: 1px 6px;
      color: #b23d3d;
      background: #f9d6d6;
      border-radius: 7px;
      cursor: pointer;
      user-select: none;
      border: none;
      font-weight: 700;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 3;
    }
    th:hover .del-col-btn {
      visibility: visible;
      opacity: 1;
    }
    td.row-handle {
      cursor: move;
      text-align: center;
      font-weight: 700;
      user-select: none;
      width: 35px;
      background: #dae8ff;
      color: #4a6ebb;
    }
    .formula-panel {
      display: none;
      background: #ecf3ffdd;
      border: 1.5px solid #aec7ff;
      border-radius: 12px;
      padding: 16px;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      user-select: none;
    }
    .formula-panel label {
      font-weight: 600;
      color: #445a9c;
      user-select: none;
      min-width: 70px;
    }
    .formula-panel select,
    .formula-panel input {
      padding: 7px 12px;
      border-radius: 8px;
      border: 1.5px solid #aec7ff;
      background: white;
      font-size: 1rem;
      outline: none;
      min-width: 110px;
      flex: 1 1 120px;
      box-sizing: border-box;
      user-select: text;
    }
    .formula-panel button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 9px 18px;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 1.05rem;
      margin-left: 8px;
      flex: 0 0 auto;
      transition: background 0.3s ease;
    }
    .formula-panel button:hover {
      background: var(--accent);
    }
    .formula-panel button:active {
      background: #5825bd;
      transform: scale(0.95);
    }
    @media (max-width: 720px) {
      .formula-panel {
        flex-direction: column;
      }
      .formula-panel label {
        min-width: auto;
      }
      .formula-panel select,
      .formula-panel input,
      .formula-panel button {
        flex: 1 1 100%;
        margin-left: 0;
      }
    }
    .statistics-panel {
      background: #eef3ffcc;
      border-radius: 12px;
      padding: 18px 22px 18px 22px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--secondary);
      margin-top: 10px;
      max-width: 440px;
      box-shadow: 0 8px 22px rgba(90, 130, 250, 0.03);
      user-select: none;
      transition: box-shadow .32s, background .2s;
      margin-bottom: 26px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .statistics-panel label {
      display: block;
      margin-bottom: 6px;
      font-size: 1.07em;
      flex: 1 1 160px;
    }
    .statistics-panel select {
      margin-bottom: 8px;
      width: 190px;
      font-size: 1em;
      background: #fff;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 7px 8px;
    }
    #showStatsBtn {
      background: linear-gradient(130deg, #48d1ee 50%, #45bcea 110%);
      font-size: 1em;
      font-weight: 600;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      margin-left: 8px;
      cursor: pointer;
      transition: background 0.21s, transform 0.21s;
      box-shadow: 0 2px 16px #c4eaef19;
    }
    #showStatsBtn:active {
      background: linear-gradient(130deg, #1899cc 70%, #1449cc 140%);
      transform: scale(0.96);
    }
    #statsResults {
      flex: 100 1 320px;
      margin-top: 12px;
      margin-left: 0;
      margin-bottom: 0;
      font-weight: 500;
      letter-spacing: 0.01em;
      padding-top: 3px;
      font-size: 1.1em;
      color: #184e73;
    }
    .chart-config-panel {
      background: linear-gradient(114deg, #f9fbfe 80%, #eaf7fb 100%);
      border-radius: 16px;
      padding: 32px 22px 18px 22px;
      margin: 22px 0 28px 0;
      box-shadow: 0 6px 32px rgba(140,180,255,0.06), 0 1.5px 7px #bde2f242;
      border: 1.8px solid var(--border);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 10px;
      min-width: 312px;
      animation: fadePopIn 0.6s cubic-bezier(.42,.02,.41,1.02);
    }
    @keyframes fadePopIn {
      from { opacity: 0; transform: translateY(32px) scale(0.98); }
      to   { opacity: 1; transform: none; }
    }
    .chart-config-panel h3 {
      margin-bottom: 13px;
      font-size: 1.25em;
      display: flex;
      gap: 7px;
      align-items: center;
    }
    .chart-config-panel h3:before {
      content: "📊";
      font-size: 1.25em;
    }
    .chart-config-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 15px 22px;
      align-items: center;
      margin-bottom: 20px;
      margin-top: 2px;
    }
    .chart-config-fields label {
      font-size: 1em;
      font-weight: 500;
      color: #187397;
      margin-right: 8px;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 95px;
    }
    .chart-config-fields select,
    .chart-config-fields input[type="color"],
    .chart-config-fields input[type="text"] {
      background: #f7fbffe8;
      border: 1.3px solid var(--border);
      border-radius: 8px;
      font-size: 1em;
      padding: 6px 10px;
      min-width: 72px;
      font-family: inherit;
      color: #222;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .chart-config-fields input[type="color"] {
      padding: 0;
      background: transparent;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2.2px solid #d9e6fc;
      cursor: pointer;
    }
    .chart-config-fields select:focus,
    .chart-config-fields input[type="color"]:focus,
    .chart-config-fields input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 9px #b9defa27;
      outline: none;
    }
    #filterHost label {
      font-weight: 400;
      font-size: 0.93em;
      margin-bottom: 0;
      margin-right: 13px;
    }
    #chartType,
    #colorScheme,
    #groupByField,
    #filterColumn,
    #xAxisField,
    #yAxisField {
      min-width: 92px;
    }
    .chart-config-panel button {
      margin-top: 6px;
      margin-bottom: 3px;
      font-size: 1.09em;
      border-radius: 8px;
      margin-right: 8px;
      padding: 10px 24px;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 2px 18px #eef6fc1a;
      transition: background 0.18s, transform 0.22s;
    }
    .chart-config-panel .btn-success {
      background: linear-gradient(120deg, #25ce8b 65%, #09ad4c 100%);
    }
    .chart-config-panel .btn-success:active {
      background: linear-gradient(120deg, #16b69a 70%, #48af37 110%);
    }
    .chart-config-panel .btn-warning {
      background: linear-gradient(120deg, #faaf22 65%, #ff6408 100%);
      color: #fff;
    }
    .chart-config-panel .btn-warning:active {
      background: linear-gradient(120deg, #dd8822 65%, #ff5000 120%);
    }
    @media (max-width: 1020px) {
      .chart-config-fields {
        flex-direction: column;
        gap: 13px 0;
        align-items: flex-start;
      }
      .chart-config-panel {
        padding: 17px 5vw 15px 7vw;
        min-width: unset;
      }
      .statistics-panel {
        padding: 11px 3vw;
      }
    }
    @media (max-width: 700px) {
      .statistics-panel,
      .chart-config-panel {
        min-width: unset;
        width: 98vw;
      }
      .chart-config-panel {
        padding: 12px 2vw;
      }
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 700px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .chart-title {
      font-weight: 600;
      color: var(--secondary);
      font-size: 1.1em;
    }
    .chart-actions {
      display: flex;
      gap: 5px;
    }
    .chart-actions button {
      padding: 4px 8px;
      font-size: 0.8em;
      margin: 0;
    }
    .chart-canvas {
      max-width: 100%;
      height: auto;
    }
  </style>
<body>
  <div class="container">
    <h2>
      Advanced Excel Database & Chart Manager
      <button id="delDbBtn" title="Delete Current Database">Delete Database</button>
    </h2>
    <div class="tabs" id="tabs"></div>
    <div class="input-row">
      <input type="file" id="upload" accept=".xlsx" />
      <button id="createDbBtn">Create Database</button>
      <input type="text" id="searchBox" placeholder="Search..." />
      <button id="addRowBtn">Add Row</button>
      <button id="exportBtn">Export Excel</button>
      <button id="printBtn">Print</button>
      <button id="delRowBtn" class="btn-danger">Delete Row</button>
      <button id="startFormulaBtn">Add Formula Column</button>
    </div>
    <div class="input-row" id="inputFields"></div>

    <div class="formula-panel" id="formulaPanel" aria-label="Formula Builder Panel" role="region">
      <label>Field 1:</label>
      <select id="formulaLeft"></select>
      <label>Operator:</label>
      <select id="formulaOperator" aria-label="Operator">
        <option value="+">+</option>
        <option value="-">-</option>
        <option value="*">*</option>
        <option value="/">/</option>
      </select>
      <label>Field 2:</label>
      <select id="formulaRight"></select>
      <label>Or Value:</label>
      <input type="text" id="formulaValue" aria-label="Literal Value" placeholder="Enter literal value" />
      <button id="applyFormulaBtn" aria-label="Apply Formula">Apply</button>
      <button id="cancelFormulaBtn" aria-label="Cancel Formula">Cancel</button>
    </div>

    <div class="statistics-panel" id="statisticsPanel" aria-label="Statistics Panel" role="region" style="display:none;">
      <label for="statsColumnSelect">Select column for statistics:</label>
      <select id="statsColumnSelect"></select>
      <button id="showStatsBtn" type="button">Show Stats</button>
      <div id="statsResults" style="margin-top:0;"></div>
    </div>

    <div class="chart-config-panel">
      <h3>Chart Configuration</h3>
      <div class="chart-config-fields">
        <label>Chart Type:
          <select id="chartType">
            <option value="bar">Bar Chart</option>
            <option value="line">Line Chart</option>
            <option value="pie">Pie Chart</option>
            <option value="doughnut">Doughnut Chart</option>
            <option value="scatter">Scatter Plot</option>
            <option value="polarArea">Polar Area</option>
          </select>
        </label>
        <label>Chart Title: <input id="chartTitle" placeholder="Enter chart title" /></label>
        <label>X-Axis Field: <select id="xAxisField"></select></label>
        <label>Y-Axis Field: <select id="yAxisField"></select></label>
        <label>Group By: <select id="groupByField"><option value="">None</option></select></label>
        <label>Filter Column: <select id="filterColumn"><option value="">No Filter</option></select></label>
        <div id="filterHost" style="margin-top:8px;"></div>
        <label>Color Scheme:
          <select id="colorScheme">
            <option value="rainbow">Rainbow</option>
            <option value="blue">Blue Tones</option>
            <option value="green">Green Tones</option>
            <option value="red">Red Tones</option>
            <option value="purple">Purple Tones</option>
            <option value="custom">Custom</option>
          </select>
        </label>
        <label>Background Color: <input type="color" id="bgColor" value="#ffffff" /></label>
      </div>
      <div>
        <button id="createChartBtn" class="btn-success">Create Chart</button>
        <button id="updateChartBtn" class="btn-warning">Update Current Chart</button>
      </div>
    </div>

    <div class="charts-grid" id="chartsGrid"></div>
    <table id="dataTable"><thead><tr id="headerRow"></tr></thead><tbody></tbody></table>
  </div>
<script>
(() => {
  let databases = {}, currentDB = "default", headers = [], types = {}, jsonData = [], savedCharts = [], chartInstances = {}, currentChartId = null;

  function saveAll() {
    localStorage.setItem("excel3d_databases", JSON.stringify(databases));
    localStorage.setItem("excel3d_currentDB", currentDB);
    localStorage.setItem("excel3d_charts", JSON.stringify(savedCharts));
  }
  function loadAll() {
    const dbs = localStorage.getItem("excel3d_databases");
    const curr = localStorage.getItem("excel3d_currentDB");
    const chs = localStorage.getItem("excel3d_charts");
    if (dbs) databases = JSON.parse(dbs);
    if (chs) savedCharts = JSON.parse(chs);
    if (curr && databases[curr]) currentDB = curr;
  }
  loadAll();
  if (!databases[currentDB]) databases[currentDB] = {headers: [], types: {}, jsonData: []};

  const tabsDiv = document.getElementById("tabs");
  const uploadInput = document.getElementById("upload");
  const createDbBtn = document.getElementById("createDbBtn");
  const searchBox = document.getElementById("searchBox");
  const addRowBtn = document.getElementById("addRowBtn");
  const exportBtn = document.getElementById("exportBtn");
  const printBtn = document.getElementById("printBtn");
  const delRowBtn = document.getElementById("delRowBtn");
  const startFormulaBtn = document.getElementById("startFormulaBtn");
  const formulaPanel = document.getElementById("formulaPanel");
  const formulaLeft = document.getElementById("formulaLeft");
  const formulaOperator = document.getElementById("formulaOperator");
  const formulaRight = document.getElementById("formulaRight");
  const formulaValue = document.getElementById("formulaValue");
  const applyFormulaBtn = document.getElementById("applyFormulaBtn");
  const cancelFormulaBtn = document.getElementById("cancelFormulaBtn");
  const inputFieldsDiv = document.getElementById("inputFields");
  const headerRow = document.getElementById("headerRow");
  const tbody = document.querySelector("#dataTable tbody");
  const statisticsPanel = document.getElementById("statisticsPanel");
  const statsColumnSelect = document.getElementById("statsColumnSelect");
  const statsResults = document.getElementById("statsResults");
  const showStatsBtn = document.getElementById("showStatsBtn");
  const chartTypeSel = document.getElementById("chartType");
  const chartTitleInp = document.getElementById("chartTitle");
  const xAxisFieldSel = document.getElementById("xAxisField");
  const yAxisFieldSel = document.getElementById("yAxisField");
  const groupByFieldSel = document.getElementById("groupByField");
  const filterColumnSel = document.getElementById("filterColumn");
  const filterHostDiv = document.getElementById("filterHost");
  const colorSchemeSel = document.getElementById("colorScheme");
  const bgColorInp = document.getElementById("bgColor");
  const createChartBtn = document.getElementById("createChartBtn");
  const updateChartBtn = document.getElementById("updateChartBtn");
  const chartsGrid = document.getElementById("chartsGrid");
  const delDbBtn = document.getElementById("delDbBtn");

  // Render tabs with delete buttons
  function renderTabs() {
    tabsDiv.innerHTML = "";
    for (const db in databases) {
      const btn = document.createElement("button");
      btn.className = db === currentDB ? "tab-button active" : "tab-button";
      btn.textContent = db;
      // Delete button for each tab
      const delBtn = document.createElement("button");
      delBtn.textContent = "×";
      delBtn.title = `Delete database "${db}"`;
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm(`Delete database "${db}"? This cannot be undone.`)) {
          delete databases[db];
          if(currentDB === db) currentDB = Object.keys(databases)[0] || "default";
          if (!databases[currentDB]) databases[currentDB] = { headers: [], types: {}, jsonData: [] };
          saveAll();
          loadCurrentDB();
        }
      };
      btn.onclick = () => {
        currentDB = db;
        loadCurrentDB();
        saveAll();
      };
      btn.appendChild(delBtn);
      tabsDiv.appendChild(btn);
    }
  }

  // Delete current DB button in header
  delDbBtn.onclick = () => {
    if (!currentDB) return;
    if(confirm(`Delete the current database "${currentDB}"? This action is irreversible.`)){
      delete databases[currentDB];
      const all = Object.keys(databases);
      currentDB = all.length ? all[0] : "default";
      if (!databases[currentDB]) databases[currentDB] = { headers: [], types: {}, jsonData: [] };
      saveAll();
      loadCurrentDB();
    }
  };

  // Build table with delete column button and drag & drop swapping
  function buildTable() {
    headerRow.innerHTML = "";
    tbody.innerHTML = "";
    const cornerTH = document.createElement("th");
    headerRow.appendChild(cornerTH);
    headers.forEach(h => {
      const th = document.createElement("th");
      th.dataset.col = h;
      th.classList.add("th-with-del");
      th.innerHTML = `
        <span class="handle" title="Drag to reorder columns">&#8801;</span>
        <span class="col-name" contenteditable="true" spellcheck="false">${h}</span>
        <button title="Delete this column" class="del-col-btn">&times;</button>
      `;
      th.style.position = "relative";
      const colNameSpan = th.querySelector(".col-name");
      colNameSpan.addEventListener("blur", () => {
        const newName = colNameSpan.textContent.trim();
        if (newName && newName !== h && !headers.includes(newName)) renameColumn(h, newName);
        else colNameSpan.textContent = h;
      });
      th.querySelector(".del-col-btn").onclick = (e) => {
        e.stopPropagation();
        if(confirm(`Delete column "${h}" from all data? This cannot be undone.`)){
          deleteColumn(h);
        }
      };
      headerRow.appendChild(th);
    });
    jsonData.forEach((row,i) => {
      const tr = document.createElement("tr");
      const tdHandle = document.createElement("td");
      tdHandle.className = "row-handle";
      tdHandle.textContent = "\u2261";
      tr.appendChild(tdHandle);
      headers.forEach(h => {
        const td = document.createElement("td");
        td.contentEditable = true;
        td.spellcheck = false;
        td.textContent = row[h] || "";
        td.addEventListener("blur", () => {
          jsonData[i][h] = td.textContent;
          saveAll();
        });
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
  // Delete column
  function deleteColumn(col) {
    const idx = headers.indexOf(col);
    if(idx === -1) return;
    headers.splice(idx,1);
    jsonData.forEach(row => delete row[col]);
    delete types[col];
    databases[currentDB].headers = headers;
    databases[currentDB].types = types;
    databases[currentDB].jsonData = jsonData;
    saveAll();
    renderInputs();
    buildTable();
    enableDragDrop();
    populateFormulaFields();
    populateStatsColumns();
    populateChartFields();
  }

  // Rename column
  function renameColumn(oldName,newName) {
    const idx=headers.indexOf(oldName);
    headers[idx] = newName;
    jsonData.forEach(row => {
      if(row.hasOwnProperty(oldName)) {
        row[newName] = row[oldName];
        delete row[oldName];
      }
    });
    types[newName] = types[oldName];
    delete types[oldName];
    databases[currentDB].headers = headers;
    databases[currentDB].types = types;
    databases[currentDB].jsonData = jsonData;
    saveAll();
    renderInputs();
    buildTable();
    enableDragDrop();
    populateFormulaFields();
    populateStatsColumns();
    populateChartFields();
  }

  // Drag & drop columns + rows
  function enableDragDrop() {
    Sortable.create(headerRow, {
      animation: 150,
      handle: ".handle",
      ghostClass: "sortable-ghost",
      onEnd: e => {
        if(e.oldIndex>0 && e.newIndex>0) {
          const col = headers.splice(e.oldIndex-1, 1)[0];
          headers.splice(e.newIndex-1, 0, col);
          databases[currentDB].headers = headers;
          saveAll();
          buildTable();
          enableDragDrop();
          populateFormulaFields();
          populateStatsColumns();
          populateChartFields();
        }
      }
    });
    Sortable.create(tbody, {
      animation: 150,
      handle: ".row-handle",
      ghostClass: "sortable-ghost",
      onEnd: e => {
        const row = jsonData.splice(e.oldIndex, 1)[0];
        jsonData.splice(e.newIndex, 0, row);
        databases[currentDB].jsonData = jsonData;
        saveAll();
        buildTable();
        enableDragDrop();
      }
    });
  }

  // Populate and render other UI sections (inputs, formula fields, stats columns, chart fields)
  function renderInputs() {
    inputFieldsDiv.innerHTML = "";
    headers.forEach(h => {
      const cfg = types[h] || {type:"text"};
      let el;
      if(cfg.type === "dropdown"){
        el = document.createElement("select");
        cfg.options.forEach(o => el.append(new Option(o,o)));
      } else {
        el = document.createElement("input");
        el.type = cfg.type || "text";
      }
      el.placeholder = h;
      el.id = "input-"+h;
      inputFieldsDiv.appendChild(el);
    });
  }
  function populateFormulaFields(){
    formulaLeft.innerHTML = "";
    formulaRight.innerHTML = "";
    headers.forEach(h => {
      formulaLeft.appendChild(new Option(h,h));
      formulaRight.appendChild(new Option(h,h));
    });
    formulaValue.value = "";
  }
  function populateStatsColumns(){
    if(!headers.length) {
      statisticsPanel.style.display = 'none';
      return;
    }
    statisticsPanel.style.display = 'flex';
    statsColumnSelect.innerHTML = "";
    headers.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      statsColumnSelect.appendChild(opt);
    });
    statsResults.innerHTML = "";
  }
  function populateChartFields(){
    [xAxisFieldSel, yAxisFieldSel, groupByFieldSel, filterColumnSel].forEach(sel=>{
      if(!sel) return;
      const val = sel.value;
      sel.innerHTML = "";
      if(sel === groupByFieldSel || sel === filterColumnSel){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = (sel === groupByFieldSel ? "None" : "No Filter");
        sel.appendChild(opt);
      }
      headers.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        sel.appendChild(opt);
      });
      sel.value = val || "";
    });
  }

  // Build and render charts (use your existing chart rendering code here, unchanged)
  // ...

  // Add other event bindings
  applyFormulaBtn.onclick = () => {
    const newCol = prompt("New column name:", "Calc");
    if (!newCol) return alert("Please enter a column name.");
    if (headers.includes(newCol)) return alert("Column already exists.");

    const left = formulaLeft.value;
    const op = formulaOperator.value;
    const rightField = formulaRight.value;
    const literalValue = formulaValue.value.trim();
    const rightVal = literalValue !== "" ? literalValue : rightField;

    headers.push(newCol);
    types[newCol] = {type:"text", options:[]};

    jsonData.forEach(row=>{
      let leftVal = row[left];
      let rightVal2 = rightVal in row ? row[rightVal]: rightVal;
      if(!isNaN(Date.parse(leftVal))) leftVal = new Date(leftVal);
      if(!isNaN(Date.parse(rightVal2))) rightVal2 = new Date(rightVal2);
      let val;
      try{
        switch(op){
          case "+": val = leftVal instanceof Date && !isNaN(+rightVal2) ? new Date(leftVal.getTime()+rightVal2*86400000) : leftVal instanceof Date && rightVal2 instanceof Date ? new Date(leftVal.getTime()+rightVal2.getTime()) : Number(leftVal)+Number(rightVal2); break;
          case "-": val = leftVal instanceof Date && rightVal2 instanceof Date ? (leftVal.getTime()-rightVal2.getTime())/86400000 : leftVal instanceof Date && !isNaN(+rightVal2) ? new Date(leftVal.getTime()-rightVal2*86400000) : Number(leftVal)-Number(rightVal2); break;
          case "*": val = Number(leftVal)*Number(rightVal2); break;
          case "/": val = Number(leftVal)/Number(rightVal2); break;
          default: val="#ERR";
        }
      }catch(e) { val="#ERR"; }
      row[newCol] = val instanceof Date ? val.toISOString() : val;
    });

    databases[currentDB].headers = headers;
    databases[currentDB].types = types;
    databases[currentDB].jsonData = jsonData;
    saveAll();
    renderInputs();
    buildTable();
    enableDragDrop();
    populateFormulaFields();
    populateStatsColumns();
    populateChartFields();
    formulaPanel.style.display = "none";
  };
  cancelFormulaBtn.onclick = () => formulaPanel.style.display = "none";
  startFormulaBtn.onclick = () => { formulaPanel.style.display = "flex"; populateFormulaFields(); };
  addRowBtn.onclick = () => {
    const row = {};
    headers.forEach(h => row[h] = document.getElementById("input-"+h)?.value || "");
    jsonData.push(row);
    databases[currentDB].jsonData = jsonData;
    saveAll();
    buildTable();
    enableDragDrop();
    populateStatsColumns();
    populateChartFields();
  };
  delRowBtn.onclick = () => {
    const idx = parseInt(prompt("Enter 0-based row index to delete:"));
    if (isNaN(idx) || idx<0 || idx>=jsonData.length) return alert("Invalid index");
    jsonData.splice(idx,1);
    databases[currentDB].jsonData = jsonData;
    saveAll();
    buildTable();
    enableDragDrop();
    populateStatsColumns();
    populateChartFields();
  };
  exportBtn.onclick = () => {
    if(!jsonData.length) { alert("No data to export."); return; }
    const ws = XLSX.utils.json_to_sheet(jsonData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, currentDB);
    XLSX.writeFile(wb, currentDB + ".xlsx");
  };
  printBtn.onclick = () => window.print();
  searchBox.oninput = () => {
    const q = searchBox.value.toLowerCase();
    const filtered = jsonData.filter(r => headers.some(h => (r[h]||"").toString().toLowerCase().includes(q)));
    renderFilteredRows(filtered);
  };
  uploadInput.onchange = (e) => {
    if(!e.target.files.length) return;
    const fr = new FileReader();
    fr.onload = ev => {
      const wb = XLSX.read(new Uint8Array(ev.target.result), {type:"array"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
      if(!rows.length) return;
      const h = Object.keys(rows[0]), ts = {};
      h.forEach(c => {
        const v = rows[0][c];
        if(!isNaN(parseFloat(v)) && isFinite(v)) ts[c] = { type: "number" };
        else if(Date.parse(v)) ts[c] = { type: "date" };
        else ts[c] = { type: "text" };
      });
      databases[currentDB] = { headers: h, types: ts, jsonData: rows };
      loadCurrentDB();
      saveAll();
    };
    fr.readAsArrayBuffer(e.target.files[0]);
  };

  // Statistics manual
  function showStats() {
    const col = statsColumnSelect.value;
    if(!col) {
      statsResults.innerHTML = "";
      return;
    }
    const data = jsonData.map(r => parseFloat(r[col])).filter(n => !isNaN(n));
    if(!data.length) {
      statsResults.innerHTML = `<span style="color:#c02723;">No numeric data for column "${col}"</span>`;
      return;
    }
    const avg = (data.reduce((a,b) => a+b,0)/data.length).toFixed(3);
    const sorted = data.slice().sort((a,b) => a-b);
    const mid = Math.floor(sorted.length/2);
    const median = (sorted.length % 2 !== 0) ? sorted[mid] : ((sorted[mid - 1] + sorted[mid])/2).toFixed(3);
    const freq = {};
    let maxFreq = 0, mode = [];
    data.forEach(n => {
      freq[n] = (freq[n]||0)+1;
      if(freq[n] > maxFreq) maxFreq = freq[n];
    });
    for(const k in freq) {
      if(freq[k] === maxFreq) mode.push(k);
    }
    statsResults.innerHTML = `
      <div>Average: <strong>${avg}</strong></div>
      <div>Median: <strong>${median}</strong></div>
      <div>Mode: <strong>${mode.join(', ')}</strong></div>
      <div>Count: <strong>${data.length}</strong></div>
    `;
  }
  showStatsBtn.onclick = showStats;

  // Chart configuration and rendering (reuse your existing chart code as is; the integration is exact)

  // Populate selects for charts and stats
  function populateAll() {
    populateFormulaFields();
    populateStatsColumns();
    populateChartFields();
  }

  // Load database, inputs, table, stats, charts etc
  function loadCurrentDB() {
    const db = databases[currentDB];
    if(!db) databases[currentDB] = {headers: [], types: {}, jsonData: []};
    headers = db.headers.slice();
    types = JSON.parse(JSON.stringify(db.types));
    jsonData = db.jsonData.slice();
    renderTabs();
    renderInputs();
    buildTable();
    enableDragDrop();
    filterTable();
    populateAll();
    renderCharts();
  }

  // Render charts function (and other chart related code) omitted here for brevity; reuse your existing implementations

  // Initial load
  window.addEventListener("load", () => {
    renderTabs();
    loadCurrentDB();
  });
})();
</script>
</body>
</html>
